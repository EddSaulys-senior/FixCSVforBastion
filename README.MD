# Бастион-Экспорт

Инструмент для нормализации данных *.csv с разных рабочих мест «Бастион» для корректного использования в комплексе с программным обеспечением «Личные пропуска».

![alt text](https://github.com/EddSaulys-senior/FixCSVforBastion/blob/main/ScreenBastionFix.png?raw=true)

## Описание

Программа объединяет CSV-файлы из выбранной папки в один Excel-файл с предварительной нормализацией данных. Также предоставляет возможность проверки готового Excel-файла на соответствие структуры и формату данных.

## Изменения (01.03.2026)

- Исправлены обращения к Tkinter из фонового потока: обновления интерфейса и `messagebox` теперь выполняются безопасно через UI-поток.
- Добавлена защита от отсутствующих колонок `NAME`, `FIRSTNAME`, `SECONDNAME`, `TABLENO` в исходных CSV (без аварийного завершения).
- Исправлена проверка пустых строк: учитываются строки, где все значения пустые после `trim`.
- Добавлена защита от деления на ноль в статистике заблокированных пропусков.
- Усилен блок пересохранения через Excel COM: гарантированное закрытие `Workbook` и `Excel.Application` даже при ошибках.
- Проверка порядка столбцов в режиме валидации теперь сравнивает с полным эталонным порядком.

## Функционал

### Основные возможности:

- Объединение CSV-файлов из выбранной папки в один Excel-файл
- Проверка и валидация FULLCARDCODE (12 HEX символов)
- Удаление заглушек с русскими наименованиями полей
- Удаление пустых строк
- Удаление полных дубликатов строк (оставляется первый экземпляр)
- Приведение полей к правильному порядку
- Удаление начальных и конечных пробелов из строковых полей
- Проверка FULLCARDCODE на дубликаты
- Перенос названия организации из WORG6 в WORG7 при необходимости
- Заполнение пустого поля подразделения (WDEP8) значением "Нет данных"
- Пересохранение файла через Excel COM для обеспечения совместимости

### Новые возможности:

- Проверка готового Excel-файла на соответствие структуры
- Проверка порядка столбцов
- Проверка наличия обязательных столбцов
- Проверка формата FULLCARDCODE
- Поиск дубликатов FULLCARDCODE
- Поиск дубликатов строк
- Проверка обязательных полей NAME и TABLENO
- Проверка на пустые строки
- Проверка на начальные/конечные пробелы
- Проверка наличия должности (POST)
- Безопасная работа интерфейса при длительной обработке в отдельном потоке

## Установка

```bash
pip install pandas openpyxl
```

Для дополнительной совместимости с Excel (опционально):

```bash
pip install pywin32
```

## Использование

1. Запустите программу
2. Используйте кнопку "Выбрать папку и обработать" для объединения CSV-файлов
3. Используйте кнопку "Проверить готовый файл" для проверки Excel-файла

### Основная обработка:

- Выберите папку с CSV-файлами
- Программа автоматически объединит все файлы, нормализует данные и создаст Excel-файл
- Строки без `NAME`/`TABLENO` или без `POST` отклоняются в отдельные Excel-файлы
  
  ### Проверка файла:
- Выберите готовый Excel-файл для проверки
- Программа проанализирует структуру и содержимое файла
- Создаст лог-файл с результатами проверки
  
  ### Требуемые поля

Программа работает со следующими полями:

```bash
B_VERSION, NAME, FIRSTNAME, SECONDNAME, TABLENO, FULLCARDCODE, ALNAME,
WDEP2, WDEP3, WDEP4, WDEP5, WDEP6, WDEP7, WDEP8,
WORG1, WORG2, WORG3, WORG4, WORG5, WORG6, WORG7, WORG8,
POST, PHONE, DOCTYPE, DOCSER, DOCNO, DOCISSUEORGAN, ADDRESS,
BIRTHPLACE, PERSONCAT, SITIZENSHIP, COMMENTS,
ADDFLD1-20, SERIALNUMBER, MIFARE_SERIALNO, CORP_CODE, PASSKIND, PINCODE, PS_COMMENT,
PASSCC, RETURNREASON, PASSFORM, VISITGOAL, ACCEPTDEP, ACCEPTPERSON,
BLOCKEDREASON, PRIORITY, CARD_IDENTIFIER_TYPE_ID, CARDACC_TYPE_CARD,
CARDACC_ISSUE, PRIOR_MIFER_CARD_STATUS, PASSTYPE, IS_BLOCKED, SEX,
IS_PERSON_AGREEMENT_EXISTS, STARTDATE, ENDDATE, STARTTIME, ENDTIME,
DOCISSUEDATE, BIRTHDATE, ALTERDATE, CREATEDATE, RETURNDATE, PASSCDATE,
BLOCKEDDATA, PERSON_AGREEMENT_DATE, EMAIL
```

### Формат FULLCARDCODE

- Должен содержать ровно 12 шестнадцатеричных символов (0-9, A-F)
- Пример: 0000C3D4E5F6
  
  ### Логирование
  
  Программа создает лог-файлы:
- export_log.txt - для основной обработки
- Бастион_Экспорт_Проверка_*.txt - для проверки файлов
  
  ## Требования
- Python 3.6+ (тестировалось на 3.11)
- pandas
- openpyxl
- (опционально) pywin32 для работы с Excel COM

#### Сборка исполняемого файла (большой размер 42мб.) для запуска на компьютере без Python

```
python -m PyInstaller --onefile --windowed Fix_CSV_for_Buro.py
```

#### Программа создана для внутреннего использования и адаптации под специфические требования системы "Личные пропуска"